name: Post to X (Twitter) with AI Lead Generation

on:
  push:
    branches:
      - main
    paths:
      - 'articles/**/*.md'
      - 'books/**/*.md'

jobs:
  post-to-x:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests requests-oauthlib

      - name: Get changed files
        id: changed-files
        run: |
          # 新規追加されたMarkdownファイルを取得
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD | grep -E '\.(md)$' | grep -E '^(articles|books)/' || echo "")
          echo "new_files=${NEW_FILES}" >> $GITHUB_OUTPUT
          
          # 変更されたMarkdownファイルを取得
          MODIFIED_FILES=$(git diff --name-only --diff-filter=M HEAD~1 HEAD | grep -E '\.(md)$' | grep -E '^(articles|books)/' || echo "")
          echo "modified_files=${MODIFIED_FILES}" >> $GITHUB_OUTPUT

      - name: Check for new published articles
        id: article-check
        run: |
          chmod +x "${{ github.action_path }}/../scripts/check-articles.sh"
          "${{ github.action_path }}/../check-articles.sh" "${{ steps.changed-files.outputs.new_files }}" "${{ steps.changed-files.outputs.modified_files }}"

      - name: Generate AI Lead Text
        if: steps.article-check.outputs.should_post == 'true'
        id: ai-lead
        uses: ./.github/actions/generate-ai-lead
        with:
          article_title: ${{ steps.article-check.outputs.article_title }}
          article_url: ${{ steps.article-check.outputs.article_url }}
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}

      - name: Post to X (Twitter)
        if: steps.article-check.outputs.should_post == 'true'
        run: |
          # Twitter APIにリクエストを送信
          python ${{ github.action_path }}/../scripts/tweet.py
        env:
          MESSAGE: ${{ steps.ai-lead.outputs.post_message }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }} 